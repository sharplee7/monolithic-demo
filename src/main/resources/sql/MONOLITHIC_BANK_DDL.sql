-- Monolithic Bank Database Schema
-- Drop existing tables and sequences
DROP TABLE IF EXISTS TB_PRODUCT CASCADE;
DROP TABLE IF EXISTS TB_TRNF_HST CASCADE;
DROP TABLE IF EXISTS TB_TRNF_LMT CASCADE;
DROP TABLE IF EXISTS TB_TRNS_HST CASCADE;
DROP TABLE IF EXISTS TB_ACNT CASCADE;
DROP TABLE IF EXISTS TB_USER CASCADE;
DROP TABLE IF EXISTS TB_CSTM CASCADE;
DROP SEQUENCE IF EXISTS SEQ_ACCOUNT_TRANSACTION_HISTORY;
DROP SEQUENCE IF EXISTS SEQ_TRANSFER_HISTORY;

-- Customer Table
CREATE TABLE TB_CSTM
(
  CSTM_ID     VARCHAR(20) NOT NULL,
  CSTM_NM     VARCHAR(100),
  CSTM_AGE    VARCHAR(3),
  CSTM_GND    VARCHAR(1),
  CSTM_PN     VARCHAR(20),
  CSTM_ADR    VARCHAR(1000),
  CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UPDATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
COMMENT ON TABLE TB_CSTM IS 'Customer';
COMMENT ON COLUMN TB_CSTM.CSTM_ID IS 'Customer ID';
COMMENT ON COLUMN TB_CSTM.CSTM_NM IS 'Customer Name';
COMMENT ON COLUMN TB_CSTM.CSTM_AGE IS 'Age';
COMMENT ON COLUMN TB_CSTM.CSTM_GND IS 'Gender';
COMMENT ON COLUMN TB_CSTM.CSTM_PN IS 'Phone Number';
COMMENT ON COLUMN TB_CSTM.CSTM_ADR IS 'Address';
ALTER TABLE TB_CSTM ADD PRIMARY KEY (CSTM_ID);

-- User Table (Authentication)
CREATE TABLE TB_USER
(
  USER_ID       VARCHAR(20) NOT NULL,
  PASSWORD_HASH VARCHAR(255) NOT NULL,
  SALT          VARCHAR(255) NOT NULL,
  EMAIL         VARCHAR(100),
  NAME          VARCHAR(100),
  STATUS        VARCHAR(20) DEFAULT 'ACTIVE',
  CREATED_DATE  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UPDATED_DATE  TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
COMMENT ON TABLE TB_USER IS 'User Authentication';
COMMENT ON COLUMN TB_USER.USER_ID IS 'User ID';
COMMENT ON COLUMN TB_USER.PASSWORD_HASH IS 'Password Hash';
COMMENT ON COLUMN TB_USER.SALT IS 'Password Salt';
COMMENT ON COLUMN TB_USER.EMAIL IS 'Email Address';
COMMENT ON COLUMN TB_USER.NAME IS 'User Name';
COMMENT ON COLUMN TB_USER.STATUS IS 'User Status';
ALTER TABLE TB_USER ADD PRIMARY KEY (USER_ID);

-- Account Table
CREATE TABLE TB_ACNT
(
  ACNT_NO     VARCHAR(20) NOT NULL,
  CSTM_ID     VARCHAR(20) NOT NULL,
  CSTM_NM     VARCHAR(20) NOT NULL,
  ACNT_NM     VARCHAR(20) NOT NULL,
  NEW_DTM     VARCHAR(20) NOT NULL,
  ACNT_BLNC   BIGINT DEFAULT 0
);
COMMENT ON TABLE TB_ACNT IS 'Account';
COMMENT ON COLUMN TB_ACNT.ACNT_NO IS 'Account Number';
COMMENT ON COLUMN TB_ACNT.CSTM_ID IS 'Customer ID';
COMMENT ON COLUMN TB_ACNT.CSTM_NM IS 'Customer Name';
COMMENT ON COLUMN TB_ACNT.ACNT_NM IS 'Account Name';
COMMENT ON COLUMN TB_ACNT.NEW_DTM IS 'Creation Date and Time';
COMMENT ON COLUMN TB_ACNT.ACNT_BLNC IS 'Account Balance';
ALTER TABLE TB_ACNT ADD PRIMARY KEY (ACNT_NO);
ALTER TABLE TB_ACNT ADD FOREIGN KEY (CSTM_ID) REFERENCES TB_CSTM(CSTM_ID);

-- Transaction History Table
CREATE TABLE TB_TRNS_HST
(
  ACNT_NO     VARCHAR(20) NOT NULL,
  SEQ         INTEGER NOT NULL,
  DIV_CD      VARCHAR(1) NOT NULL,
  STS_CD      VARCHAR(1) NOT NULL,
  TRNS_AMT    BIGINT DEFAULT 0,
  ACNT_BLNC   BIGINT DEFAULT 0,
  TRNS_BRNCH  VARCHAR(20) NOT NULL,
  TRNS_DTM    VARCHAR(20) NOT NULL
);
COMMENT ON TABLE TB_TRNS_HST IS 'Transaction History';
COMMENT ON COLUMN TB_TRNS_HST.ACNT_NO IS 'Account Number';
COMMENT ON COLUMN TB_TRNS_HST.SEQ IS 'Sequence Number';
COMMENT ON COLUMN TB_TRNS_HST.DIV_CD IS 'Division Code';
COMMENT ON COLUMN TB_TRNS_HST.STS_CD IS 'Status Code';
COMMENT ON COLUMN TB_TRNS_HST.TRNS_AMT IS 'Transaction Amount';
COMMENT ON COLUMN TB_TRNS_HST.ACNT_BLNC IS 'Account Balance';
COMMENT ON COLUMN TB_TRNS_HST.TRNS_BRNCH IS 'Transaction Branch';
COMMENT ON COLUMN TB_TRNS_HST.TRNS_DTM IS 'Transaction Date and Time';
ALTER TABLE TB_TRNS_HST ADD PRIMARY KEY (ACNT_NO, SEQ);
ALTER TABLE TB_TRNS_HST ADD FOREIGN KEY (ACNT_NO) REFERENCES TB_ACNT(ACNT_NO);

-- Transfer Limit Table
CREATE TABLE TB_TRNF_LMT
(
  CSTM_ID         VARCHAR(20) NOT NULL,
  ONE_TM_TRNF_LMT BIGINT DEFAULT 0,
  ONE_DY_TRNF_LMT BIGINT DEFAULT 0,
  CREATED_DATE    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UPDATED_DATE    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
COMMENT ON TABLE TB_TRNF_LMT IS 'Transfer Limit';
COMMENT ON COLUMN TB_TRNF_LMT.CSTM_ID IS 'Customer ID';
COMMENT ON COLUMN TB_TRNF_LMT.ONE_TM_TRNF_LMT IS 'One Time Transfer Limit';
COMMENT ON COLUMN TB_TRNF_LMT.ONE_DY_TRNF_LMT IS 'One Day Transfer Limit';
ALTER TABLE TB_TRNF_LMT ADD PRIMARY KEY (CSTM_ID);
ALTER TABLE TB_TRNF_LMT ADD FOREIGN KEY (CSTM_ID) REFERENCES TB_CSTM(CSTM_ID);

-- Transfer History Table
CREATE TABLE TB_TRNF_HST
(
  CSTM_ID       VARCHAR(20) NOT NULL,
  SEQ           INTEGER NOT NULL,
  DIV_CD        VARCHAR(1) NOT NULL,
  STS_CD        VARCHAR(1) NOT NULL,
  DPST_ACNT_NO  VARCHAR(20),
  WTHD_ACNT_NO  VARCHAR(20),
  WTHD_ACNT_SEQ INTEGER,
  SND_MM        VARCHAR(100),
  RCV_MM        VARCHAR(100),
  RCV_CSTM_NM   VARCHAR(100),
  TRNF_AMT      BIGINT DEFAULT 0,
  TRNF_DTM      VARCHAR(20)
);
COMMENT ON TABLE TB_TRNF_HST IS 'Transfer History';
COMMENT ON COLUMN TB_TRNF_HST.CSTM_ID IS 'Customer ID';
COMMENT ON COLUMN TB_TRNF_HST.SEQ IS 'Sequence Number';
COMMENT ON COLUMN TB_TRNF_HST.DIV_CD IS 'Division Code';
COMMENT ON COLUMN TB_TRNF_HST.STS_CD IS 'Status Code';
COMMENT ON COLUMN TB_TRNF_HST.DPST_ACNT_NO IS 'Deposit Account Number';
COMMENT ON COLUMN TB_TRNF_HST.WTHD_ACNT_NO IS 'Withdrawal Account Number';
COMMENT ON COLUMN TB_TRNF_HST.WTHD_ACNT_SEQ IS 'Withdrawal Account Sequence';
COMMENT ON COLUMN TB_TRNF_HST.SND_MM IS 'Sender Memo';
COMMENT ON COLUMN TB_TRNF_HST.RCV_MM IS 'Receiver Memo';
COMMENT ON COLUMN TB_TRNF_HST.RCV_CSTM_NM IS 'Receiver Customer Name';
COMMENT ON COLUMN TB_TRNF_HST.TRNF_AMT IS 'Transfer Amount';
COMMENT ON COLUMN TB_TRNF_HST.TRNF_DTM IS 'Transfer Date and Time';
ALTER TABLE TB_TRNF_HST ADD PRIMARY KEY (CSTM_ID, SEQ);
ALTER TABLE TB_TRNF_HST ADD FOREIGN KEY (CSTM_ID) REFERENCES TB_CSTM(CSTM_ID);

-- Product Table (converted from DynamoDB)
CREATE TABLE TB_PRODUCT
(
  ID            VARCHAR(50) NOT NULL,
  NAME          VARCHAR(100) NOT NULL,
  DESCRIPTION   TEXT,
  INTEREST_RATE DECIMAL(5,4) DEFAULT 0.0000,
  CURRENCY      VARCHAR(10) DEFAULT 'KRW',
  CREATED_DATE  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UPDATED_DATE  TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
COMMENT ON TABLE TB_PRODUCT IS 'Product';
COMMENT ON COLUMN TB_PRODUCT.ID IS 'Product ID';
COMMENT ON COLUMN TB_PRODUCT.NAME IS 'Product Name';
COMMENT ON COLUMN TB_PRODUCT.DESCRIPTION IS 'Product Description';
COMMENT ON COLUMN TB_PRODUCT.INTEREST_RATE IS 'Interest Rate';
COMMENT ON COLUMN TB_PRODUCT.CURRENCY IS 'Currency';
ALTER TABLE TB_PRODUCT ADD PRIMARY KEY (ID);

-- Create Sequences
CREATE SEQUENCE SEQ_ACCOUNT_TRANSACTION_HISTORY START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_TRANSFER_HISTORY START WITH 1 INCREMENT BY 1;

-- Create Indexes for better performance
CREATE INDEX IDX_TB_ACNT_CSTM_ID ON TB_ACNT(CSTM_ID);
CREATE INDEX IDX_TB_TRNS_HST_ACNT_NO ON TB_TRNS_HST(ACNT_NO);
CREATE INDEX IDX_TB_TRNS_HST_TRNS_DTM ON TB_TRNS_HST(TRNS_DTM);
CREATE INDEX IDX_TB_TRNF_HST_CSTM_ID ON TB_TRNF_HST(CSTM_ID);
CREATE INDEX IDX_TB_TRNF_HST_TRNF_DTM ON TB_TRNF_HST(TRNF_DTM);